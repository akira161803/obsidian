
Date: 2025-09-24
Tags: 
Links:  [[WSA]], [[File Upload Vulnerabilities]]

***

最も厳密なブラックリストであっても、古典的な難読化技術を使えば回避できる可能性があります。たとえば、バリデーションコードが大文字と小文字を区別する場合、「exploit.pHp」が「.php」ファイルであることを認識できないことがあります。一方で、ファイル拡張子をMIMEタイプにマッピングするコードが大文字と小文字を区別しない場合、この不一致によって、悪意のあるPHPファイルをバリデーションをすり抜けてアップロードし、最終的にサーバーで実行される可能性があります。

同様の結果を得るために、以下のような手法も使用できます：

- **複数の拡張子を付ける**：ファイル名の解析アルゴリズムによっては、「exploit.php.jpg」がPHPファイルとして解釈される場合もあります。
- **末尾に文字を追加する**：一部のコンポーネントは、末尾の空白、ドットなどを無視または削除します。例：「exploit.php.」
- **URLエンコード（または二重エンコード）を使用する**：ドットやスラッシュをエンコードした「exploit%2Ephp」などは、バリデーション時にデコードされず、サーバー側で後からデコードされることで、ブロックされるはずのファイルがアップロードできてしまう可能性があります。
- **セミコロンやURLエンコードされたヌルバイトを拡張子の前に追加する**：PHPやJavaなどの高級言語でバリデーションされても、C/C++などの低レベル関数で処理されると、ファイル名の終端の扱いに不一致が生じることがあります。例：「exploit.asp;.jpg」や「exploit.asp%00.jpg」
- **マルチバイトUnicode文字を使用する**：UTF-8文字列として解析された後、ASCIIに変換される過程で、xC0 x2E、xC4 xAE、xC0 xAE などのシーケンスが x2E（ドット）に変換される可能性があります。
- **危険な拡張子を除去・置換する防御策を逆手に取る**：この変換が再帰的に適用されない場合、禁止された文字列を巧妙に配置することで、除去後に有効な拡張子が残るようにできます。例：「exploit.p.phphp」から「.php」を除去しても、まだ「.php」が残っている可能性があります。

これは、ファイル拡張子を難読化するための手法のほんの一部にすぎません。

---
## Lab

- pngとjpegしか受け付けない設定。
- `webshell.php%00.png`で送信。

***
# References

https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-obfuscated-file-extension