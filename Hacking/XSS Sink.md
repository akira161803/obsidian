
Date: 2025-09-21
Tags: 
Links: [[XSS]]、[[WSA]]

***
- **ソース = 外部入力が入ってくる場所**
- **シンク = その入力が危険に処理される場所**

## **ネイティブ DOM 関数 / プロパティ**

- **document.write() / document.writeln()**
    
    - 文字列を現在のドキュメントストリームに直接書き込む（writeln は末尾に改行を付ける）。
        
    - 危険性：入力をそのまま出力すると HTML/スクリプトを挿入できるため XSS に直結。
        
    - 対策：生データを直接書かない。必要ならテキストノード化（textContent）や適切なエスケープを行う。使わない設計にする。
        
    
- **document.domain**
    
    - 現在のドメイン（同一オリジンの緩和）を取得／設定するプロパティ。
        
    - 危険性：不適切な設定でサブドメイン間の境界を緩めると、攻撃面が広がり、DOM XSS の影響範囲が増える。
        
    - 対策：原則変更しない。クロスドメイン共有が必要な場合は安全なポリシーを検討する。
        
    
- **element.innerHTML**
    
    - 要素の HTML を取得／設定する。
        
    - 危険性：ユーザー入力をそのまま innerHTML に入れると任意の HTML／スクリプトが実行される。
        
    - 対策：可能な限り textContent／innerText を使う。HTML を動的生成する場合はテンプレート化＋厳格なエスケープを行う。
        
    
- **element.outerHTML**
    
    - 要素自身を含む HTML を取得／設定する（要素を丸ごと書き換え）。
        
    - 危険性：innerHTML 同様、外部入力を入れるとスクリプト挿入のリスク。
        
    - 対策：outerHTML に生データを直接入れない。DOM API（createElement, appendChild 等）で構築する。
        
    
- **element.insertAdjacentHTML(position, html)**
    
    - 指定した位置（beforebegin/afterbegin/beforeend/afterend）に HTML を挿入する。
        
    - 危険性：渡した HTML をそのまま解析して挿入するため、未検証の入力は XSS の入口となる。
        
    - 対策：挿入する文字列はエスケープするか、可能なら DOM ノードを生成して挿入する。
        
    
- **element.onevent（例：element.onclick = ...）**
    
    - 要素の on* プロパティに直接イベントハンドラ（文字列や関数）をセットする。
        
    - 危険性：属性として文字列をセットするとインライン JS 実行につながる。外部から取得したコードを代入すると危険。
        
    - 対策：addEventListener で関数を登録し、外部入力を評価しない。文字列でのハンドラ設定は避ける。
        
    

---

## **jQuery の関数（簡潔に）**

  

> ※jQuery の多くの DOM 挿入系メソッドは内部で HTML 解析／挿入を行うため、**未検証の入力がそのまま渡ると DOM-XSS に繋がる**点は共通です。

  

- **add()**
    
    - 既存の jQuery セットに要素／セレクタを追加して集合を拡張する。
        
    - 危険性：追加対象を HTML 文字列で渡すと解析される（間接的に挿入となる）。
        
    - 対策：要素参照や安全なノードを渡す。
        
    
- **after() / before()**
    
    - 指定要素の直後／直前にコンテンツを挿入する。
        
    - 危険性：HTML 文字列を渡すとパースして挿入され、スクリプトが混入する可能性。
        
    - 対策：DOM ノードを渡すかエスケープ済みテキストを使う。
        
    
- **append() / prepend()**
    
    - 要素の末尾／先頭にコンテンツを追加する。
        
    - 危険性：渡された HTML がそのまま挿入されると XSS の原因に。
        
    - 対策：テキストは text()、要素は生成したノードを渡す。
        
    
- **animate()**
    
    - CSS プロパティをアニメーションする（数値やプロパティ名を指定）。
        
    - 危険性：プロパティ値に未検証の文字列を使い、スタイル属性経由で不正な動作を誘発する可能性（比較的間接的）。
        
    - 対策：アニメーション対象／値はホワイトリスト化されたものだけ使う。
        
    
- **insertAfter() / insertBefore()**
    
    - 指定要素の後／前に要素を挿入する（append/before と似ているが逆操作）。
        
    - 危険性：挿入内容が HTML 文字列だと解析され実行される恐れ。
        
    - 対策：安全なノードを使う。
        
    
- **replaceWith() / replaceAll()**
    
    - 要素を別のコンテンツで置換する。replaceAll は逆引き的な呼び出し。
        
    - 危険性：置換用の HTML にスクリプトが含まれると危険。
        
    - 対策：HTML 文字列の使用を避け、ノードで置換する。
        
    
- **wrap() / wrapInner() / wrapAll()**
    
    - 要素の周りに新しいラッパー要素を追加する（wrapInner は内部要素を包む）。
        
    - 危険性：ラッパー指定を HTML 文字列で渡すと解析される。
        
    - 対策：既存の要素を使うか、$('`<div>`') のように安全に生成する。
        
    
- **html()**
    
    - 要素の HTML を取得／設定する（jQuery の innerHTML 相当）。
        
    - 危険性：ユーザー入力を直接 html() に渡すと XSS。
        
    - 対策：text() を使う、または厳格にエスケープする。
        
    
- **prepend()（上に記載）**
    
    - 何をするか／注意点：上参照。
        
    
- **has()**
    
    - 指定した要素／セレクタを子に持つ要素をフィルタする（問い合わせ系）。
        
    - 危険性：通常は読み取り系だが、返した要素集合を不注意に HTML 挿入に使うと問題の起点になる。
        
    - 対策：読み取り用途に限定し、挿入時は入力を検証する。
        
    
- **constructor() / init()（jQuery 内部）**
    
    - jQuery オブジェクトの内部的な初期化関数（通常はライブラリ内部で使われる）。
        
    - 危険性：通常アプリコードで直接呼ぶことはないが、ライブラリ拡張等で HTML 文字列を扱うと XSS に結びつく可能性がある。
        
    - 対策：ライブラリ内部の取り扱いを理解し、外部入力を内部初期化に流さない。
        
    
- **index()**
    
    - 要素の位置（インデックス）を返す（問い合わせ）。
        
    - 危険性：基本は読み取り専用で XSS の直接原因にはなりにくい。だが結果をテンプレートに埋め込む等で誤用すると間接的リスク。
        
    - 対策：数値として扱い、HTML 埋め込み時はエスケープする。
        
    
- **jQuery.parseHTML() / $.parseHTML()**
    
    - 文字列として与えた HTML を DOM ノード配列に変換するユーティリティ（安全オプションを指定できる）。
        
    - 危険性：未検証の HTML を解析するとスクリプトノードが作られ実行され得る（script ノードの扱いに注意）。
        
    - 対策：信頼できる HTML のみに使う、もしくは keepScripts オプションを false にしてスクリプトを除去する／入力をエスケープする。
        
    

---

## **共通の短い対策まとめ**

1. **生の HTML 文字列を直接挿入しない。** 可能なら textContent / text() を使う。
    
2. **ユーザー入力は必ずエスケープまたはサニタイズする。** 特に HTML コンテキストへ入る場合。
    
3. **DOM を直接組み立てる（createElement 等）** ことで挿入時の解釈を制御する。
    
4. **コンテンツセキュリティポリシー（CSP）** を導入してインラインスクリプト実行を制限する。
    
5. **ライブラリ／フレームワークの安全な API を優先する。**（テンプレートエンジン等）
    

---

要点：リスト中の多くは「**HTML を解析して DOM に埋め込む**」操作を行うため、**外部から来た文字列をそのまま渡すと DOM-XSS の典型的経路**になります。用途ごとに「HTML を使うかテキストを使うか」を明確にして、テキストなら必ずテキスト API を使うのが最もシンプルで確実な防御です。

  

***
# References